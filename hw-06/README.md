# README

## Описание

### Предметная область
Служба вызова такси.

### Требования
- Пользователь МОЖЕТ создать более одного заказа (вызвать две машины). 
- Пользователь НЕ может создать второй заказ случайно. Например: пользователь нажал кнопку "Заказать", не получил ответа, перезапустил приложение и отправил новый заказ. 

### Решение
Процесс описан диаграммой `./data/sequence_diagram.png`.
<br/>
В запросе на создание заказа клиент передает ключ идемпотентности.
Этот ключ сохраняется вместе с заказом в таблицу `orders` и является уникальным для каждого заказа.
Клиент получает ключ из таблицы `idempotency_key_pool`. В этой таблице хранятся ключи для каждого клиента.
После того как заказ успешно создан, для клиента генерируется новый ключ идемпотентности и сохраняется в таблицу `idempotency_key_pool`, замещая старый ключ.
При создании заказа приложение проверяет, есть ли заказ с данным ключем. Если есть, то сервер вернет код 409.
<br/>
<br/>
Ключ возвращается вместе со списком заказов для что бы клиент точно знал создан заказ или нет, прежде чем отправить запрос на создание заказа с новым ключем.  
<br/>
<br/>
Тест-кейсы:
1. Пользователь случайно нажал "Заказать" дважды. На первый запрос сервер создаст заказ, на второй - вернет 409.
2. Пользователь нажал "Заказать", но запрос задержался в сети. 
  Пользователь не дождался ответа и перезапустил приложение, после чего создал новый заказ.
  Результат: 
  а) Если первый заказ был создан, то GET /orders вернет новый ключ идемпотентности и созданный заказ.
  б) Если первый заказ не был создан, то GET /orders вернет старый ключ идемпотентности, а значит пользователь не сможет создать новый заказ.
<br/>
### order-service API

```
GET /orders

```

POST /orders

## Установка

Выполните следующие команды из корневой директории:

```
kubectl create namespace app
helm dependency build ./kubernetes/app-chart
helm install app -n app ./kubernetes/app-chart -f ./kubernetes/app-chart/values.yaml
```
Запуск приложения занимает около 30 секунд.

Создайте туннель:

`minikube tunnel`

## Отправка запросов

Коллекция postman содержит последовательность запросов, согласно описанию в ДЗ:

`data/hw-06.postman_collection.json`

## Удаление

Выполните следующие команды:
```
helm uninstall app --namespace app
kubectl delete namespace app
```
В процессе установки приложения создается Persistent Volume размером 10Mi.
Возможно его потребуется удалить вручную командой `kubectl delete pv имя_persistent_volume`.