# Приложение "Служба такси"

## Глоссарий

* Пассажир - заказывает такси.
* Водитель - отвечает на заказ и осуществляет перевозку.
* Администратор - устанавливает тарифры.

## Компоненты приложения
### Микросервисы

* identity-provider    - хранит информацию о пользователях, выдает JWT токены. Сторонее решение (например Keycloak).
* user-service         - предоставляет API для выполнения CRUD операций над пользователями. Не хранит данные пользователей.
                         Делегирует CRUD запросы identity-provider-у.
* order-service        - хранит информацию о заказах и тарифах.
* car-locator-service  - хранит текущее месторасположение Водителей и их статус.
* route-service        - выполняет построение маршрута.
* payment-service      - хранит данные карточек, осуществляет оплату.
* notification-service - отправляет все виды уведомлений (SMS, email).

### Сторонние сервисы

* Сервис онлайн-платежей  - непосредственно выполняет платеж, с ним взаимодействует PaymentService.
* Картографический сервис - предоставляет изображение карты.

### Другие компоненты

* Очередь сообщений - обеспечивает асинхронное взаимодействие сервисов. Хранение истории сообщений не требуется. Возможная реализация: RabbitMQ.

### Описание работы системы

Пассажир выполняет вход в мобильное приложение и начинает формировать заказ: он выбирает пункт подачи и назначения,
тариф и дополнительные опции (детское автокресло и т.п.). Когда все обязательные поля заполнены,
Пассажир вызывает `OrderService.PrepareOrder()`. Система проверяет: существует ли "черновик" заказа?
"Черновик" - это заказ который сформирован, но не отправлен. Пользователь мог сформировать такой заказ раньше, но передумал и не стал вызывать такси.
Если "черновик" есть - он обновляется новыми данными. Если нет - создается новый.<br/></br>
На этом этапе Пассажир видит стоимость заказа и может вызвать такси. Стоимость заказа уже хранится в БД в `order-service`
и может поменятся ТОЛЬКО если был вызван метод `OrderService.PrepareOrder()`.
Это нужно что бы исключить внезапное изменение стоимости непосредственно перед заказом машины (например пошел дождь и цены выросли).<br/></br>
Затем Пассажир вызывает `OrderService.PlaceOrder()`. Этот метод помещает сообщение `FIND_DRIVER` в очередь сообщений и сразу же возвращает управление.
`car-locator-service` получает сообщение и начинает поиск Водителя.
Поиск осуществляется так: каждый Водитель нажимает кнопку "Начать работу" в мобильном приложении,
которая вызывает метод `CarLocatorService.WaitForOrder()`. Этот метод возвращает gRPC-stream через который будут поступать заказы.
Когда поступает заказ, вместе с ним Водителю передается метка времени, которая называется `deadline`.
Если Водитель не вызовет `OrderService.ApplyOrder()` до наступления `deadline`, то заказ будет передан другому Водителю.
Примечание: мы отправляем `deadline` Водителю, для того что бы избежать следующей ситуации: ответ от сервера задержался в сети и Водитель принял заказ,
который уже был передан другому Водителю.</br>
Вызов `OrderService.ApplyOrder()` помещает сообщение `STOP_DRIVER_SEARCH` в очередь. `car-locator-service` получает это сообщение и начинает поиск.<br/></br>
После прибытия в пункт назначения Водитель отправляет запрос `OrderService.CompleteOrder()`. После этого Пассажир может вызвать `OrderService.CloseOrder()` что бы оценить и оплатить заказ.
Если Пассажир не сделает этого в течении времени N оплата будет произведена автоматически.

### Диаграммы

Все диаграммы находятся в директории diagrams.
* component.png               - описывает зависимости между компонентами системы. Стрелка "от А к Б" означает что А зависит от Б.
                                Для повышения читабельности диаграмма НЕ содержит: ingress, identity-provider, БД. 
                                Все запросы пользователя к сервисам проходят через ingress, который обращается к identity-provider для получения JWT-токена.
* place_order_seq.png         - Пассажир заказывает такси.
* apply_order_seq.png         - Водитель принимает заказ.

### API сервисов

Сервисы взаимодействуют по gRCP. Причины: бинарный протокол, возможность создавать "потоки событий" (stream). Например, Водитель может использовать stream что бы передавать свои координаты. 
Пожалуйста см. описание контрактов в grcp-proto. Каждая **директория** соответствует отдельному **микросервису**.
Один *.proto файл - это один сервис **внутри** данного микросервиса. Например OrderService и TariffService оба находятся внутри микросервиса order-service. 

### Очередь сообщений

Помимо API также используется очередь сообщений (например, RabbitMQ). На данный момент в очередь могут помещатся следующие сообщения.

| Сообщение              | Параметры | Получатель           | Описание                                                                             |
|------------------------|-----------|----------------------|--------------------------------------------------------------------------------------|
| FIND_DRIVER            | order_id  | car-locator-service  | Получив это сообщение, сервис начинает поиск ближайшего свободного Водителя.         |
| STOP_DRIVER_SEARCH     | order_id  | car-locator-service  | Получив это сообщение, сервис прекращает поиск Водителя.                             |
| CONTINUE_DRIVER_SEARCH |           | car-locator-service  | Получив это сообщение, сервис предлагает данный заказ следующему в списке Водителю.  |

## Сценарии

**Сценарий:** Рассчет стоимости поездки<br/>
**Есть** авторизованный Пассажир<br/>
**Когда** Пассажир указывает пункты подачи и назначения И выбирает тариф<br/>
**Тогда** Пассажир видит стоимость поездки<br/><br/>

**Сценарий:** Рассчитанная стоимость поездки не меняется если администратор меняет тариф<br/>
**Есть** Пассажир видит стоимость поездки<br/>
**Когда** Администратор меняет тариф<br/>
**Тогда** Пассажир видит прежнюю стоимость поездки<br/>
ПРИМЕЧАНИЕ: в будущем тариф сможет менятся автоматически (например цены растут во время дождя).
Этот сценарий применим и к данным случаям.<br/><br/>

**Сценарий:** Перерассчет стоимости поездки если Пассажир поменял пункт назначения (выбрал другой тариф, выбрал дополнительные опции)<br/>
**Есть** Заполненная форма заказа И Пассажир видит стоимость поездки<br/>
**Когда** Пассажир меняет пункт назначения<br/>
**Тогда** Пассажир видит новую стоимость поездки<br/>
ПРИМЕЧАНИЕ: аналогичные сценарии для изменения пункта подачи, выбора другого тарифа и дополнительных опций.<br/><br/>

**Сценарий:** Ближайшие Водители по очереди получают уведомление после того как Пассажир оставил заказ<br/>
**Есть** Заполненная форма заказа<br/>
**Когда** Пассажир оставляет заказ<br/>
**Тогда** Водитель А получает уведомление И не реагирует на уведомление N секунд<br/>
И Водитель Б получает уведомление И не реагирует на уведомление N секунд<br/>
И Водитель В получает уведомление И принимает заказ<br/>
И Водитель Г **не** получает уведомление<br/><br/>

**Сценарий:** Один из Водителей принимает заказ<br/>
**Есть** Пассажир оставляет заказ<br/>
**Когда** Водитель принимает заказ<br/>
**Тогда** Пассажир видит сообщение "Машина прибудет чере N минут"<br/><br/>

**Сценарий:** Ни один из Водителей не принимает заказ<br/>
**Есть** Пассажир оставляет заказ<br/>
**Когда** Ни один из Водителей не принимает заказ<br/>
**Тогда** Пассажир видит сообщение "Нет свободных машин"<br/><br/>

**Сценарий:** Водитель нажимает кнопку "Прибыл" (вызов `OrderService.completeOrder()`)<br/>
**Есть** Пассажир оставляет заказ И Водитель принимает заказ<br/>
**Когда** Водитель нажимает на кнопку "Прибыл"<br/>
**Тогда** Пассажир видит сообщение "Машина прибыла"<br/><br/>

**Сценарий:** Пользователь оставил заказ, но платежная карточка не валидна<br/>
**Есть** Заполненная форма заказа И привязанная карточка невалидна<br/>
**Когда** Пассажир оставляет заказ<br/>
**Тогда** Метод оплаты меняется на "Наличные"<br/>
И Пассажир получает уведомление "Невозможно использовать платежную карту. Выбран метод оплаты наличными."<br/><br/>

**Сценарий:** Водитель нажал кнопку "Готово" и Пассажир получил возможность оценить поездку<br/>
**Есть** Пассажир оставил заказ И Водитель принял его<br/>
**Когда** Водитель нажал кнопку "Готово"<br/>
**Тогда** Пассажир видит предложение оценить поездку и закрыть заказ (нажать кнопку "Готово")<br/>
ПРИМЕЧАНИЕ: Водитель нажимает кнопку "Готово" после того как привозит Пассажира в пункт назначения.<br/><br/>

**Сценарий:** Пассажир нажал кнопку "Готово". Оплата прошла<br/>
**Есть** Пассажир оставил заказ И Водитель принял его И Водитель нажал кнопку "Готово"<br/>
**Когда** Пассажир нажал кнопку "Готово"<br/>
**Тогда** Заказ оплачен<br/><br/>

**Сценарий:** Водитель нажал "Готово", а Пассажир не нажал<br/>
**Есть** Пассажир оставил заказ И Водитель принял его И Водитель нажал кнопку "Готово"<br/>
**Когда** Пассажир не нажал кнопку "Готово" в течении времени N<br/>
**Тогда** Заказ автоматически оплачен<br/><br/>

## Сценарии сбоев
Сценарии ниже описывают реакцию системы на сбои в работе сети и недоступность некоторых сервисов<br/><br/>

**Сценарий:** Не пришло подтверждение о работоспособности платежной карточки<br/>
**Есть** Пассажир оставил заказ И Водитель принял его<br/>
**Когда** Подтверждение о работоспособности карточки не пришло И Водитель нажал кнопку "Готово"<br/>
**Тогда** Метод оплаты меняется на "Наличные"<br/><br/>

#### Сразу несколько Водителей принимают заказ<br/>
**Есть** Пассажир оставил заказ<br/>
**Когда** Водитель А принял заказ<br/>
И его запрос задержался в сети<br/>
И CarLocatorService подождал N секунд и отправил предложение о заказе Водителю Б<br/>
И Водитель Б принял заказ И заказ был обработан CarLocatorService<br/>
**Тогда** Водитель А видит сообщение "Заказ уже принят другим Водителем"<br/><br/>

**Сценарий:** Пассажир получает SMS если Водитель принял заказ, а приложение Пассажира не работает<br/>
**Есть** Пассажир оставил заказ И завершил работу приложения<br/>
**Когда** Водитель принял заказ<br/>
**Тогда** Пользователь получает SMS "Машина в пути"<br/><br/>

**Сценарий:** Пассажир получает SMS если машина прибыла, а приложение Пассажира не работает<br/>
**Есть** Пассажир оставил заказ И Водитель принял заказ И Пассажир завершил работу приложения<br/>
**Когда** Водитель нажал кнопку "Прибыл"<br/>
**Тогда** Пользователь получает SMS "Машина прибыла"